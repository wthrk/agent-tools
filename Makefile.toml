[config]
default_to_workspace = false

[tasks.fmt]
command = "cargo"
args = ["fmt", "--all", "--check"]

[tasks.check]
command = "cargo"
args = ["check", "--workspace", "--all-targets"]

[tasks.clippy]
command = "cargo"
args = ["clippy", "--workspace", "--all-targets", "--", "-D", "warnings"]

[tasks.deny]
command = "cargo"
args = ["deny", "check"]

[tasks.test]
command = "cargo"
args = ["test", "--workspace"]

[tasks.ci]
dependencies = ["fmt", "check", "clippy", "deny", "test", "skill-test"]

[tasks.skill-test]
script = '''
#!/bin/bash
# Skip the leading "--" separator from cargo-make
if [ "$1" = "--" ]; then
  shift
fi
if [ $# -eq 0 ]; then
  cargo run -p skill-test --release -- \
    skills/* \
    --iterations 1 \
    --hook forced \
    --threshold 80 \
    --timeout 180000
else
  cargo run -p skill-test --release -- "$@"
fi
'''

# Integration tests with limited parallelism to reduce CPU load
[tasks.integration-test]
command = "cargo"
args = ["test", "-p", "skill-test", "--features", "integration-test", "--", "--test-threads=2"]

# Docker tests for skill-tools
[tasks.docker-test]
command = "docker"
args = ["compose", "-f", "skill-tools/docker-compose.test.yaml", "run", "--rm", "test"]

[tasks.docker-test-build]
command = "docker"
args = ["compose", "-f", "skill-tools/docker-compose.test.yaml", "build", "--no-cache", "test"]

# Install: build and copy to ~/.skill-tools/bin/
[tasks.install]
dependencies = ["build-release", "copy-binaries"]

[tasks.build-release]
command = "cargo"
args = ["build", "--release", "-p", "skill-tools", "-p", "skill-test"]

[tasks.copy-binaries]
script_runner = "@duckscript"
script = '''
home_dir = get_home_dir
bin_dir = set "${home_dir}/.skill-tools/bin"
mkdir ${bin_dir}
cp target/release/skill-tools ${bin_dir}/skill-tools
cp target/release/skill-test ${bin_dir}/skill-test
echo Installed: ${bin_dir}/skill-tools
echo Installed: ${bin_dir}/skill-test
echo
echo Add to shell profile:
dollar = set "$"
path_line = concat "  export PATH=" ${bin_dir} ":" ${dollar} "PATH"
echo ${path_line}
'''
